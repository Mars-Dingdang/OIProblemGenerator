# 浅谈一类最小公倍数的求和问题及其拓展

**Author:** 张隽恺

### 关键思想与技巧

#### 1. **质因数分解的向量化表示**
- 设前 n 个数中所有质数为 $ p_1, p_2, \ldots, p_k $。
- 每个正整数 $ a \leq n $ 可唯一表示为 $ a = \prod_{i=1}^k p_i^{q_i} $，其分解式记作向量 $ F_a = (q_1, q_2, \ldots, q_k) $。
- 则有性质：$ \text{LCM}(S) $ 的分解式等于 $ \max_{a \in S} F_a $，其中 $ \max $ 定义为逐维取最大值。

#### 2. **高维前缀和优化计数**
- 定义 $ h_F $：满足所有元素 $ a $ 的 $ F_a \leq F $ 的子集数量，则 $ h_F = 2^{\text{ct}_F} $，其中 $ \text{ct}_F $ 是满足 $ F_a \leq F $ 的 $ a $ 的个数。
- $ \text{ct}_F $ 可通过高维前缀和技术在 $ O(S_n \cdot k) $ 内计算，$ S_n = \prod_{i=1}^k (\lfloor \log_{p_i} n \rfloor + 1) $ 是可能的 LCM 种类数。

#### 3. **动态规划中的状态合并（核心创新）**
- 设 $ g_{i,F} $ 表示考虑前 $ i $ 个数、子集 LCM 分解式为 $ F $ 的方案数。
- 引入贡献函数 $ v_{i,F} = \sum_{S \subseteq \{i+1,\ldots,n\}} \text{LCM}\left( \prod_j p_j^{q_j}, \text{LCM}(S) \right) $，并证明总答案恒等于 $ \sum_F g_{i,F} \cdot v_{i,F} $。

#### 4. **无效状态的线性合并（Lemma 2.7）**
- 若当前状态 $ F $ 中某维 $ q_a > q'_a $，其中 $ q'_a $ 是 $ \text{LCM}(i+1,\ldots,n) $ 在该维的最大指数，则该状态对后续无独立贡献。
- 此时可将 $ g_{i,F} $ 合并到 $ F' = (q_1,\ldots,q_a-1,\ldots,q_k) $ 上，并乘以因子 $ p_a $，即：
  
  $$
  v_{i,F} = p_a \cdot v_{i,F'}
  $$
  
  因此操作 $ g_{i,F'} \gets g_{i,F'} + p_a \cdot g_{i,F} $，然后置 $ g_{i,F} = 0 $，不改变总答案。

#### 5. **动态维护有效状态域**
- 维护当前所有非零状态必须满足 $ F \leq L_i = \min(F_{\text{LCM}(1..i)}, F_{\text{LCM}(i+1..n)}) $。
- 使用高维前缀和数组 $ f_F = \sum_{F' \leq F} g_{F'} $ 来优化转移和合并操作。
- 每一步 DP 包括：
  1. **截断状态空间**：限制 $ F \leq L'_i $，更新 $ f $ 数组；
  2. **加入新元素 $ i $**：若 $ F_i \leq F $，则 $ f'_F = 2 \cdot f_F $，否则不变；
  3. **合并无效状态**：沿每一维进行“降维”合并，利用公式调整 $ f $ 数组，确保状态不超过后续 LCM 上界。

#### 6. **排序优化状态增长**
- 将数字按**最大质因子从大到小**排序（相同则按数值从小到大），使得大质因子尽早被处理，从而更早地限制状态空间维度的增长。
- 实验表明此排序显著降低总状态数 $ T'_n $，使算法可处理 $ n \leq 2000 $。

#### 7. **推广至一般形式**
- 算法可拓展至求和形式：
  $$
  \sum_{S \subseteq \{1..n\}} \left( \prod_{i\in S} a_i \right) \cdot f(\text{LCM}(S))
  $$
  其中 $ f $ 是积性函数。只需调整转移系数和贡献定义即可。

#### 8. **进一步优化方向**
- 使用随机化方法（如模拟退火）寻找更优的处理顺序，可进一步减小 $ T''_n $，但尚无理论最优解法。