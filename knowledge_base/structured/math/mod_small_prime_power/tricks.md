# 一些经典问题模小质数幂的做法

**Author:** 武林

### 关键技巧与观察

#### 1. **模 $p^k$ 下的拉格朗日插值可行性**
- 定理1指出：若已知一个次数小于 $n$ 的多项式 $F(x)$ 在 $x=1,2,...,n$ 处的点值模 $p^k$，则对任意整数 $x_0$，$F(x_0) \bmod p^k$ 可被唯一确定。
- 原因在于拉格朗日插值公式的系数 $\prod_{j \ne i} \frac{x_0 - j}{i - j}$ 实际上是一个整数（由引理2保证 $k! \mid n^k$），因此整个表达式是整系数线性组合，模信息足够还原结果。

#### 2. **多项式多点求值的优化**
- 利用引理3：$x^{p^k} \equiv 0 \pmod{p^k}$ 对所有整数 $x$ 成立（因为 $(p^k)! \mid x^{p^k}$ 且 $\nu_p((p^k)!) \ge k$）。
- 因此，任何整系数多项式 $F(x)$ 模 $p^k$ 的行为在 $\mathbb{Z}/p^k\mathbb{Z}$ 上是周期性的或可截断的。只需预处理 $F(0), F(1), ..., F(p^k - 1)$ 或更少点（如利用阶的性质降至约 $(p-1)k$ 个点），之后可用插值快速查询任意点值。

#### 3. **组合数模 $p^k$ 的计算（扩展Lucas）**
- 核心是将 $n!$ 分解为 $p^{\nu_p(n!)} \times f_p(n)$，其中 $f_p(n)$ 是去掉所有 $p$ 因子后的部分且与 $p$ 互素。
- $\nu_p(n!)$ 用勒让德公式计算：$\sum_{i=1}^\infty \lfloor n / p^i \rfloor$。
- 计算 $f_p(n)$ 使用递归：$f_p(n) = f_p(\lfloor n/p \rfloor) \times \left(\prod_{1\le i \le n, p\nmid i} i\right)$。
- 关键优化：将乘积部分拆分为完整块和剩余部分，并构造生成函数 $F_m(x) = \prod_{0\le i<m} \prod_{1\le j<p} (\frac{i}{j}x + 1)$，使得原式变为 $(p-1)!^m F_m(p)$。
- 利用 $\ln F_m(x)$ 展开后其系数是关于 $m$ 的低次多项式，再通过 $\exp$ 还原 $F_m(x)$ 的前 $k$ 项，最终得到 $F_m(p) \bmod p^k$ 是关于 $m$ 的不超过 $2k-2$ 次多项式，从而可通过预处理 $2k-1$ 个点值并使用拉格朗日插值快速查询。

#### 4. **短多项式高次幂远处系数（模 $p^k$）**
- **基础（$k=1$）**：使用引理 $F^p(x) \equiv F(x^p) \pmod{p}$（由费马小定理和组合数性质导出），实现指数和目标次数的“进制分解”递归：将 $[x^t]F^m(x)$ 转化为规模更小的子问题 $[x^{a_2}]F^{a_1}(x)H_{b_2}(x)$，其中 $m = a_1p + b_1$, $t = a_2p + b_2$。
- **推广（$k>1$）**：使用更强的同余 $F^{p^k}(x) \equiv F^{p^{k-1}}(x^p) \pmod{p^k}$，结合归纳法处理更高幂次。递归过程中维护模 $p^{k-1}$ 的信息，并利用类似方法降维。

#### 5. **复合逆系数与另类拉格朗日反演**
- 避免标准拉格朗日反演中需要对 $n$ 求逆的问题，改用形式：
  $$[x^n]G^m(x) = [x^{-m-1}]F'(x)F^{-n-1}(x) = [x^{n-m}]F'(x)\left(\frac{F(x)}{x}\right)^{-n-1}$$
- 此形式不涉及除以 $n$，可以直接套用“短多项式高次幂远处系数”的算法框架，适用于负次数幂的情况。

#### 6. **二项卷积避免除法**
- 传统方法需计算 $a_i/i!$，但在 $p \le n$ 时 $i!$ 可能无逆元。
- 改进方法：将组合数拆解为 $p$-进赋值和单位部分：
  $$\binom{i}{j} = p^{\nu_p(i!) - \nu_p(j!) - \nu_p((i-j)!)} \cdot \frac{f_p(i)}{f_p(j)f_p(i-j)}$$
- 定义新序列 $\hat{a}_i = a_i / f_p(i) \bmod p^k$，则卷积变为：
  $$\hat{c}_i = \sum_j p^{e_{i,j}} \hat{a}_j \hat{b}_{i-j}, \quad e_{i,j} = \nu_p(i!) - \nu_p(j!) - \nu_p((i-j)!)$$
- 由 Kummer 定理，$e_{i,j}$ 等于 $i-j$ 在 $p$-进制下减法的退位次数，且最大不超过 $\lfloor \log_p n \rfloor$，因此总贡献不会超过 $n^2 p^{2k}$，可用多个 NTT 模数计算后 CRT 合并。

#### 7. **多项式指数函数（Exp）避免积分除法**
- 标准牛顿迭代在积分步骤 $\int \frac{G'_0(x)}{G_0(x)} dx$ 中需除以次数，当模数含小质因子时可能不可行。
- 解决方案：不维护 $[x^i]G(x)$，而是维护 $G^{(i)}(0) = i! [x^i]G(x)$，即导数值。
- 此时求导和积分操作转化为乘除 $x$ 和二项卷积，避免了除以整数的操作，结合前述二项卷积技巧，可在 $O(n \log n)$ 时间内完成。