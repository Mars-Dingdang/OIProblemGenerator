## 关键观察与优化

1. **试除法优化**：只需检查到 √n，因为若 n 有因子 d，则 n/d 也是因子，成对出现。
2. **费马素性测试的缺陷**：存在 Carmichael 数（如 561）能通过所有基底的费马测试，因此需要更强的测试。
3. **Miller–Rabin 的核心**：结合费马小定理和二次探测定理。
   - 将 n-1 分解为 u·2^t（u 奇数）。
   - 对随机基底 a，计算 v = a^u mod n。
   - 若 v=1 或 v=n-1，通过本轮；否则平方 t 次，若出现 n-1 则通过，若始终未出现则 n 为合数。
4. **确定性基底集**：
   - 对于 32 位整数：{2, 7, 61} 足够。
   - 对于 64 位整数：{2, 325, 9375, 28178, 450775, 9780504, 1795265022} 或前 12 个素数。
5. **反素数（Highly Composite Numbers）**：
   - 定义：小于 n 的任何数因子个数都少于 n 的因子个数。
   - 性质：
     - 由连续小素数幂次乘积构成。
     - 素数指数非递增（k₁ ≥ k₂ ≥ ...）。
   - 求解：DFS 枚举素数指数，剪枝条件：
     - 当前值 > 上限。
     - 当前因子数 > 目标且值已更大。
     - 利用素数指数递减性质减少搜索。
6. **常见变换**：
   - 将素数判定转化为因子个数问题（反素数）。
   - 利用小范围确定性测试避免随机化。
   - 对于大数，先用小素数试除再运行 Miller–Rabin。
7. **溢出处理**：使用 `__int128` 或拆位乘法处理中间乘积的模运算。