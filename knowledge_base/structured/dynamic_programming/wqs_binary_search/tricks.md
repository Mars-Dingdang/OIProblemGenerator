## 关键观察
1. **凸性前提**：WQS 二分要求原问题的价值函数 $v(y)$ 关于限制 $y$ 是凸的（最小化）或凹的（最大化）。这是算法可行的核心条件。
2. **惩罚调整**：通过引入线性惩罚 $\lambda \cdot g(x)$，将带限制问题转化为无限制问题，惩罚系数 $\lambda$ 控制选取数量。
3. **单调性**：最优选取数量 $g(x_\lambda)$ 关于 $\lambda$ 单调（非增）。

## 共线处理
- **基本方法**：在求解 $h(\lambda)$ 时，记录 $g(x_\lambda)$ 并使其尽可能大（或小），二分条件改为 $g(x_\lambda) \ge y$（或 $\le y$）。
- **实数二分**：当 $\lambda$ 为整数时，使用实数二分可避免跳过正确斜率，最后取整即可。

## 对偶视角
- **凸共轭**：$h(\lambda) = -v^*(\lambda)$，其中 $v^*$ 是 $v$ 的凸共轭。
- **强对偶**：若 $v$ 是凸函数，则 $v(y) = \sup_{\lambda} [h(\lambda) + \lambda y]$。
- **次梯度**：$g(x_\lambda)$ 的范围由 $\partial(-h(\lambda))$ 给出，对于整数情形为 $[h(\lambda-1)-h(\lambda), h(\lambda)-h(\lambda+1)]$。

## 凸性证明方法
1. **归约为凸优化**：将原问题建模为线性规划/网络流，其价值函数自动凸。
2. **状态转移归纳**：对 DP 状态 $f(i, j)$ 归纳证明 $f(i, \cdot)$ 凸。
3. **四边形不等式**：对于区间分拆问题，若成本函数满足四边形不等式，则价值函数凸。
4. **交换论证**：直接通过交换操作证明凸性。

## 常见应用模式
- **带数量限制的选取问题**：如选 $m$ 个物品最大化收益，且物品间有依赖（如间隔限制）。
- **图论问题**：如限定边数的最大权匹配、最小生成树 $k$ 边问题。
- **序列分割**：将序列分成 $m$ 段使总代价最小，且段代价函数凸。

## 实现细节
- **二分边界**：惩罚 $\lambda$ 的范围需足够大以覆盖所有可能数量。
- **精度**：整数问题中，实数二分精度只需达到能区分整数斜率即可。
- **记录方案**：若需输出方案，可在 DP 中同时记录转移路径，最后用求得的 $\lambda$ 重构。

## 复杂度
- 单次 $h(\lambda)$ 计算复杂度 $O(T(n))$，总复杂度 $O(T(n) \log L)$，其中 $L$ 为 $\lambda$ 范围。
- 高维 WQS 二分复杂度为 $O(T(n) \log^d L)$，可用三分/黄金分割。

## 注意事项
- 凸性必须验证，否则算法可能失败。
- 共线情形必须正确处理，否则二分可能无法终止或得到错误结果。
- 当 $g(x_\lambda)$ 不便于记录时，可使用对偶方法避免记录。

## 扩展
- **Aliens Trick**：WQS 二分的国外常见名称，源于 IOI 2016 Aliens 题。
- **高维限制**：可处理多个限制（$d>1$），但复杂度随维度指数增长。
- **在线版本**：结合数据结构（如平衡树）维护凸壳，支持动态插入物品。