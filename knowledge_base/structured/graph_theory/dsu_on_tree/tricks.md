- **轻重儿子划分**：利用树链剖分中的重儿子概念，确保每个节点最多被遍历 $ O(\log n) $ 次。
- **路径上的轻边数不超过 $ \log n $**：这是复杂度正确性的关键，因为每次走轻边子树大小至少减半。
- **保留重儿子结果**：避免重复计算，仅清空轻儿子影响，从而将总复杂度优化至 $ O(n \log n) $。
- **非递归实现（DFS 序优化）**：通过倒序遍历 DFS 序，利用重链连续性，减少函数调用开销，尤其适合深树或链状结构。
- **批量添加/删除子树**：利用 DFS 序的连续性，对轻儿子子树整段遍历更新，提高缓存友好性。
- **空间复用技巧**：全局计数数组 `cnt` 在非保留分支结束后清零，保证空间复杂度为 $ O(n) $。