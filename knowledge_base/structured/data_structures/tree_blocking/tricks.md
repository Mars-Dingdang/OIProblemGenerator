- **块构建方式**：使用 DFS 栈控制块大小，当子树中未分配块的节点数达到阈值 $B \approx \sqrt{n}$ 时，将当前节点设为关键点并封闭一块。
- **预处理关键点间信息**：对每个关键点向上跳至祖先关键点，用 `bitset` 维护路径上的颜色集合，存储在二维数组 `bs[i][j]` 中，便于快速合并路径信息。
- **查询路径拆解**：将路径分为三部分——端点到其块的关键点、关键点之间的块跳跃、LCA 附近暴力合并。利用预处理的 bitset 加速中间段。
- **高效 bitset 操作**：使用 `bitset::count()` 快速统计颜色数量；通过 `_Find_first()` 或手写前导零查找求 mex（最小未出现颜色）。
- **优化技巧**：
  - 使用编译器内置函数（如 `_tzcnt_u32`, `_tzcnt_u64`）加速 bitset 的最低位 1 查找。
  - 对于更高性能需求（如每 16 位批量处理），可手写 bitset 分段查表，预处理连续 1 的长度等信息。
- **注意事项**：树分块虽灵活但常被更优算法（如树链剖分、点分治）替代；需注意菊花图等极端结构可能破坏块平衡性（如“gty 的妹子树”）。