## 关键观察
- **Fail指针性质**：AC自动机的fail边构成一棵内向树（fail树）。
- **字典图优化**：在`build`过程中，将不存在的转移`tr[u].son[c]`直接指向`tr[tr[u].fail].son[c]`，从而将Trie扩展为有向图（字典图），实现O(1)状态转移，避免跳多次fail。

## 优化技巧
1. **拓扑排序优化**：
   - 问题：朴素查询需要沿fail链跳转统计，最坏O(模式串总长 * 文本串长)。
   - 方法：在`build`时记录每个结点在fail树上的入度。查询时只在当前结点打标记（`ans++`），最后在fail树上从叶子到根拓扑排序累加答案。
   - 复杂度：O(∑|s_i| + |S| + n)。
2. **DFS优化**：与拓扑排序本质相同，在fail树上做后序遍历（子树求和）。
3. **状态压缩优化**（适用于模式串长度≤20）：
   - 在每个结点维护一个位掩码`stat`，表示从该结点开始的fail链上所有模式串长度集合。
   - 查询时维护当前文本前缀的长度掩码，通过位运算`&`快速判断是否有匹配。
   - 例题：P2292 [HNOI2004] L 语言。

## 常见问题转化
- **多模式匹配计数**：直接使用模板，注意去重（标记已计数结点）。
- **出现位置记录**：在查询时记录匹配结点，通过fail树还原所有匹配位置。
- **AC自动机上DP**：将AC自动机作为状态机，结合动态规划（如计数DP、最优化DP）。
  - 典型例题：
    - 禁止某些子串出现（如DNA序列）。
    - 求包含所有模式串的最短字符串。
- **结合数据结构**：在fail树上套用树状数组、线段树等处理子树查询。

## 注意事项
- 字符集较大时（如Unicode），可使用`map`或`unordered_map`存储转移，但会增大常数。
- 内存紧张时，可改用动态分配（如`vector`存储子结点）或双数组Trie压缩。
- 若只判断是否存在匹配（不计数），可在插入时标记终止结点，查询时遇到标记即可返回。