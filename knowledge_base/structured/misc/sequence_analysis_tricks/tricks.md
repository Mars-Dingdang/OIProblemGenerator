# 序列相关问题的一些思路总结

**Author:** 范斯喆

## 关键思想与技巧总结

### 1. 统计区间贡献
- **可减性判断**：若区间贡献具有可减性（如区间和），可用前缀和作差处理。
- **不可减贡献处理**：对于非可减量（如区间最小值），使用扫描线或分治。
  - 在分治框架下，枚举值域点 `x`，维护左右最近 ≤x 的位置距离（`p`, `q`），利用 Segment Tree Beats 支持区间取 min 和贡献更新（`w += p × q`）。
- **笛卡尔树应用**：区间最值问题可转化为 LCA 问题。例如，在例题 Subsequence2 中，通过笛卡尔树将区间最小值求和转化为每个节点作为 LCA 的二元组贡献统计，进而进行树形背包 DP。

### 2. 统计二元组贡献
- 枚举一个变量，计算合法另一个变量的贡献。
- 利用单调性剪枝：如在求最大 LCM 问题中，从大到小枚举数值，并维护候选栈；若当前数与栈中某数互质，则中间更小的数无法产生更大贡献。
- 使用莫比乌斯反演统计互质对数量：
  
  $\sum_{x \in S} [\gcd(x, a_i) = 1] = \sum_{d | a_i} \mu(d) \cdot \text{count}_S(d)$
  
  其中 `count_S(d)` 是集合 `S` 中是 `d` 倍数的元素个数，可通过倍数数组维护。

### 3. 待定序列的生成顺序
- **按值从小到大插入**：适用于代价依赖相邻关系的问题（如波浪排列）。采用“相对插入”视角，记录连续段数、边界空位数，进行四维 DP。
- **关键位置优先确定**：如 Emotional Fishermen 中，只关注前缀最大值的位置，按值排序后进行 DP，其余数在满足条件区间内任意排列。
- **同时按值和下标确定**：如 Permutation Oddness 中，枚举 `i` 并决定 `p_i` 和 `p'_i` 相对于 `i` 的大小关系，结合匹配思想设计状态压缩型 DP。

### 4. 序列操作分析
#### 减少操作可能性
- 分析操作之间的替代关系，排除冗余方案。
  - 如优先执行高自由度操作（操作二），再补操作一；
  - 限制操作长度为 3/4/5；
  - 避免重复相同操作（可用一次操作一替代多次）；
  - 最终通过状态压缩 DP 解决（状态维度低至 j≤2, k≤2）。

#### 逆操作思维
- 将原操作序列倒置，转化为从目标向初始状态推导。
  - 如基础循环结构练习题中，原操作 mod 和 add 转化为减法和加倍数，便于控制最小值增长。
  - 通过构造“将最小值提升至超过最大值”的复合操作，实现整体递增调整。

#### 操作功能绑定
- 多次操作组合成新功能：如 Circular Xor Reversal 中，利用异或链构造交换两个元素的功能，类似经典三步异或交换法。
- 设计函数 `f(i,j)` 实现 `a_i := a_i ⊕ a_j`，从而完成交换，总操作次数优化至约 `1.25n²`。

### 5. 寻找组合不变量 / 构造辅助序列
#### 逆序对分析
- 交换操作改变逆序对奇偶性 → 可用于判定无解（如 The same permutation 中要求操作总数为偶数）。
- 最少相邻交换次数等于逆序对数。

#### 差分序列构造
- 如方差问题中，构造 `b_i = a_i − a_{i−1}`，发现操作等价于交换 `b_i` 和 `b_{i+1}` → 最终 `b` 可重排。
- 方差最小当且仅当差分数组形成单谷排列 → 排序后用 DP 决策放左或右。

#### 符号交替前缀和（bi = Σ(−1)^j aj）
- 千百问题中，定义 `b_i = sum_{j=0}^i (−1)^j a_j`，则操作等价于交换 `b_{i−1}` 和 `b_i`。
- 目标状态对应 `b` 严格单调 → 等价于对“族”（模 n 同余类）排序 → 转化为二维偏序计数问题。

#### 二元组/三元组集合维护
- Latin Square 中维护 `(i, j, a[i][j])` 三元组，六种操作均可表示为坐标变换，避免直接模拟矩阵变化。
- 支持高效批量更新，最终复原矩阵仅需 O(n²)。

#### 建图法
- **置换环模型**：Inverse Transformation 中，排列看作映射图，`f(i)` 为所在环长，`Σ1/f(i)` 为环个数。
  - 操作 `a_i ← a_{a_i}` 对应环分裂：偶环分裂为两个，奇环不变。
  - 逆过程合并环以最小化初始环数。
- **边连接建图（ai + 1 → ai+1）**：排序大师中加入哨兵 0 和 n+1，构建图使得目标为 n+1 个自环。
  - 操作影响两条入边和两条出边，最多改变环数 ±2，且不改变奇偶性 → 得出有解条件。
- **前缀和图 → 欧拉路径**：Flip and Reverse 中将 01 序列转为 ±1 前缀和图，操作对应翻转一个环上的边方向。
  - 最终状态为无向图的一条欧拉路径 → 字典序最小即贪心选择最小字典序路径。