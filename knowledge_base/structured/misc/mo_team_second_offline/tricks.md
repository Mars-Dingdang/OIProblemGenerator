- **差分转移贡献**：将莫队中每次移动端点的贡献拆分为前缀形式，例如 $f(x, l, r) = f(x, 1, r) - f(x, 1, l-1)$，从而支持离线批量处理。
- **预处理固定项**：形如 $f(r, r-1)$ 或 $g(r, r-1)$ 的项可在开始前用树状数组或值域分块预处理，时间复杂度 $O(n \log n)$。
- **二次离线存储优化**：利用连续段合并技巧，将每个移动操作的多个单点查询合并为区间处理，空间从 $O(n\sqrt{m})$ 降为 $O(m)$。
- **值域分块加速查询**：对于“插入数”和“查排名”类问题，使用值域分块实现 $O(\sqrt{n})$ 插入、$O(1)$ 查询，优于树状数组在高频查询下的表现。
- **答案增量+前缀和还原**：莫队维护的是答案变化量，最终需对询问按顺序做前缀和才能得到真实答案。
- **扫描线处理离线事件**：将所有待处理的 $f(x, p)$ 按 $p$ 离线存入数组，然后从小到大枚举位置并更新数据结构，统一计算贡献。